# docker-compose.yml
version: '3.8'

services:
  px4-all-in-one:
    image: px4-all-in-one:latest
    container_name: px4-sim
    hostname: px4-sim
    privileged: true
    network_mode: host
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - PX4_SIM_MODEL=iris
      - PX4_GZ_WORLD=empty
      - ROS_DOMAIN_ID=0
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/home/simuser/.Xauthority:ro
      - ${HOME}/PX4-Autopilot:/workspace/PX4-Autopilot:rw
      - ${HOME}/.ccache:/home/simuser/.ccache:rw
      - ${HOME}/.gazebo:/home/simuser/.gazebo:rw
      - ${HOME}/.ros:/home/simuser/.ros:rw
      - /dev/dri:/dev/dri
      - /dev/shm:/dev/shm
    shm_size: 2gb
    working_dir: /workspace/PX4-Autopilot
    stdin_open: true
    tty: true
    command: >
      bash -c "
        if [ ! -f 'build/px4_sitl_default/bin/px4' ]; then
          make px4_sitl
        fi
        make px4_sitl gz_iris
      "